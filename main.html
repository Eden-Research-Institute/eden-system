<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDEN INSTITUTE - DASHBOARD</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-color: #121212; --sidebar-bg: #1e1e1e; --card-bg: #252525;
            --border: #333; --accent: #00ff9d; --danger: #ff4b4b; --text-main: #ffffff; --text-sub: #888;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 240px; height: 100vh; background-color: var(--sidebar-bg); border-right: 1px solid var(--border); position: fixed; top: 0; left: 0; display: flex; flex-direction: column; padding: 20px; z-index: 100; overflow-y: auto; }
        .logo { font-size: 16px; font-weight: 700; color: var(--accent); letter-spacing: 2px; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .logo::before { content: 'â–'; font-size: 20px; }
        .menu-item { padding: 12px 15px; color: var(--text-sub); border-radius: 6px; margin-bottom: 4px; transition: 0.2s; font-size: 14px; display: flex; align-items: center; gap: 12px; font-weight: 500; text-decoration: none; }
        .menu-item:hover, .menu-item.active { background-color: rgba(0, 255, 157, 0.05); color: var(--accent); }
        .profile-box { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .avatar { width: 32px; height: 32px; background: #333; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #fff; font-size: 14px; }
        .user-info { cursor: pointer; }
        .user-info:hover h4 { color: var(--accent); text-decoration: underline; }
        .user-info h4 { margin: 0; font-size: 13px; color: #fff; font-weight: 600; }
        .user-info p { margin: 0; font-size: 11px; color: var(--danger); margin-top: 3px; font-weight: bold;}

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content { margin-left: 240px; padding: 30px; display: grid; grid-template-columns: 2fr 1fr; grid-template-rows: auto auto; gap: 20px; min-height: 100vh; }
        .header-area { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .page-title h1 { margin: 0; font-size: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;}
        .page-title p { margin: 5px 0 0; color: var(--text-sub); font-size: 12px; }
        .clock-area { text-align: right; display: block !important; }
        .clock-time { font-size: 24px; font-weight: 600; color: var(--text-main); letter-spacing: 1px; }
        .clock-date { font-size: 11px; color: var(--text-sub); margin-top: 2px; text-transform: uppercase; text-align: right;}

        /* ì¹´ë“œë“¤ */
        .card { background-color: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 25px; position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 12px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        .status-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 5px var(--accent); }
        
        .ripley-card { grid-column: 1 / 2; grid-row: 2 / 4; background: linear-gradient(160deg, #252525 0%, #1a1a1a 100%); border-left: 3px solid var(--accent); }
        .subject-id { font-size: 24px; font-weight: 600; color: #fff; letter-spacing: 1px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;}
        .subject-name-kr { font-size: 16px; color: var(--accent); font-weight: 400; }
        
        /* ì¸í„°í° ë²„íŠ¼ */
        .intercom-btn { 
            background: rgba(0, 255, 157, 0.1); border: 1px solid var(--accent); 
            color: var(--accent); padding: 4px 10px; border-radius: 4px; 
            font-size: 12px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 5px;
        }
        .intercom-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }

        .subject-desc { font-size: 13px; color: #888; margin-top: 5px; line-height: 1.5;}
        .vital-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .vital-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); }
        .vital-label { font-size: 11px; color: #666; display: block; margin-bottom: 8px; letter-spacing: 0.5px; }
        .vital-value { font-size: 18px; font-weight: 600; color: #e0e0e0; }
        .bpm-value { color: var(--accent); font-size: 24px; }
        .monitor-line { width: 100%; height: 2px; background: #333; margin: 30px 0; position: relative; overflow: hidden; }
        .monitor-active { position: absolute; width: 100px; height: 100%; background: var(--accent); box-shadow: 0 0 15px var(--accent); animation: scan 2s infinite linear; }
        @keyframes scan { 0% { left: -20%; } 100% { left: 120%; } }

        .stats-card { grid-column: 2 / 3; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-size: 13px; color: #aaa; }
        .stat-num { font-size: 14px; font-weight: 600; color: #fff; }

        .info-card { grid-column: 2 / 3; }
        .system-list div { padding: 8px 0; font-size: 13px; display: flex; justify-content: space-between; }
        .ok { color: var(--accent); } .warn { color: #ffaa00; } .lock { color: var(--danger); }

        /* ìˆ˜ì‹ í•¨ ëª¨ë‹¬ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center;
        }
        .inbox-container {
            width: 800px; height: 600px; background: #1e1e1e; border: 1px solid #444; border-radius: 8px;
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .inbox-header {
            padding: 15px 20px; background: #252525; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .inbox-title { font-weight: bold; color: var(--accent); font-size: 14px; letter-spacing: 1px; }
        .close-btn { cursor: pointer; font-size: 20px; color: #888; } .close-btn:hover { color: #fff; }
        
        .inbox-body { display: flex; flex: 1; overflow: hidden; }
        .msg-list { width: 40%; border-right: 1px solid #333; overflow-y: auto; background: #1a1a1a; }
        .msg-item { padding: 15px; border-bottom: 1px solid #2a2a2a; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; }
        .msg-item:hover { background: #252525; }
        .msg-item.active { background: #2a2a2a; border-left-color: var(--accent); }
        .msg-item.unread .msg-sender, .msg-item.unread .msg-preview { font-weight: bold; color: #fff; }
        .msg-item.unread::after { content: 'â—'; float: right; color: var(--danger); font-size: 10px; margin-top: 3px;}
        .msg-sender { font-size: 12px; color: #ccc; display: block; margin-bottom: 4px; }
        .msg-type { font-size: 10px; padding: 2px 5px; border-radius: 3px; background: #333; color: #aaa; margin-right: 5px; }
        .msg-preview { font-size: 13px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .msg-content { flex: 1; padding: 30px; overflow-y: auto; background: #1e1e1e; }
        .view-header { border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
        .view-subject { font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 10px; }
        .view-meta { font-size: 12px; color: #666; }
        .view-body { font-size: 14px; line-height: 1.6; color: #ddd; white-space: pre-wrap; }
        .empty-state { text-align: center; color: #555; margin-top: 100px; font-size: 13px; }

        /* â–¼â–¼â–¼ ì¸í„°í° ì±„íŒ…ì°½ (ëŒ€ì‹œë³´ë“œ ì „ìš© ìŠ¤íƒ€ì¼) â–¼â–¼â–¼ */
        .intercom-box {
            display: none; position: fixed; bottom: 20px; right: 20px; 
            width: 350px; height: 500px; background: #121212; 
            border: 1px solid var(--accent); border-radius: 4px; 
            z-index: 9999; box-shadow: 0 0 20px rgba(0, 255, 157, 0.1);
            flex-direction: column;
        }
        .intercom-header {
            padding: 10px 15px; background: rgba(0, 255, 157, 0.1); 
            border-bottom: 1px solid var(--accent); color: var(--accent); 
            font-size: 13px; font-weight: bold; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .intercom-body {
            flex: 1; padding: 15px; overflow-y: auto; font-family: 'JetBrains Mono', monospace;
            font-size: 12px; color: #ddd; display: flex; flex-direction: column; gap: 10px;
        }
        .intercom-input-area {
            padding: 10px; border-top: 1px solid #333; display: flex; gap: 5px;
        }
        .intercom-input {
            flex: 1; background: #1a1a1a; border: 1px solid #333; color: #fff; 
            padding: 8px; outline: none; font-family: 'Inter', sans-serif;
        }
        .intercom-input:focus { border-color: var(--accent); }
        .intercom-send {
            background: var(--accent); color: #000; border: none; padding: 0 15px; 
            cursor: pointer; font-weight: bold;
        }
        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .i-msg { max-width: 90%; padding: 8px; border-radius: 4px; line-height: 1.4; word-break: break-all;}
        .i-msg.user { align-self: flex-end; text-align: right; color: var(--accent); border: 1px solid var(--accent); background: rgba(0,255,157,0.05); }
        .i-msg.bot { align-self: flex-start; color: #fff; border: 1px solid #444; background: #1a1a1a; }
        .i-msg.sys { align-self: center; color: #666; font-style: italic; border: none; background: none; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 55px; flex-direction: row; align-items: center; border-right: none; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; padding: 0 10px; padding-right: 130px; overflow-x: auto; white-space: nowrap; }
            .sidebar::-webkit-scrollbar { display: none; }
            .logo { display: none; }
            .menu-item { margin-bottom: 0; margin-right: 5px; background: #222; padding: 6px 10px; height: 36px; }
            .profile-box { position: fixed; top: 0; right: 0; width: 120px; height: 55px; background: #1a1a1a; border-left: 2px solid var(--border); border-top: none; display: flex !important; justify-content: center; z-index: 1000; padding: 0; margin: 0; box-shadow: -5px 0 10px rgba(0,0,0,0.5); }
            .main-content { margin-left: 0; padding: 15px; display: flex; flex-direction: column; }
            .header-area { flex-direction: column; align-items: flex-start; gap: 5px; }
            .clock-area { text-align: left; margin-top: 5px; }
            
            .inbox-container { width: 95%; height: 80%; }
            .inbox-body { flex-direction: column; }
            .msg-list { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid #333; }
            .msg-content { height: 60%; }
            
            .intercom-box { width: 90%; right: 5%; bottom: 20px; height: 60%; }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">EDEN LAB.</div>
        <a href="main.html" class="menu-item active"><span>ğŸ“Š</span> <span>ëŒ€ì‹œë³´ë“œ</span></a>
        <a href="subjects.html" class="menu-item"><span>ğŸ§¬</span> <span>ì‹¤í—˜ì²´ ê´€ë¦¬</span></a>
        <a href="facility.html" class="menu-item"><span>ğŸ¢</span> <span>ì‹œì„¤ ê´€ë¦¬</span></a>
        <a href="staff.html" class="menu-item"><span>ğŸ‘¥</span> <span>ì¡°ì§/ì¸ì‚¬</span></a>
        <a href="public.html" target="_blank" class="menu-item"><span>ğŸŒ</span> <span>ëŒ€ì™¸ í™ˆí˜ì´ì§€</span></a>
        <div class="profile-box">
            <div class="avatar">K</div>
            <div class="user-info" onclick="openInbox()">
                <h4>KAIRO</h4> <p style="color:var(--danger);">LEVEL 5</p>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="header-area">
            <div class="page-title"><h1>Main Console</h1> <p>INTEGRATED CONTROL SYSTEM</p></div>
            <div class="clock-area mono"><div class="clock-time" id="clock">00:00:00</div><div class="clock-date" id="date">YYYY-MM-DD</div></div>
        </div>

        <div class="card ripley-card">
            <div class="card-header"><span class="card-title" style="color:var(--accent);">CORE ASSET MONITORING</span> <span class="status-dot"></span></div>
            <div class="subject-info">
                <div class="subject-id mono">
                    ER-S-02-001 <span class="subject-name-kr">(ë¦¬í”Œë¦¬)</span>
                    <button class="intercom-btn" onclick="toggleIntercom()"><span class="blink">ğŸ’¬</span> INTERCOM</button>
                </div>
                <div class="subject-desc">í˜„ì¬ ìœ ì¼í•œ 2ë‹¨ê³„(ì¬ìƒ) ë„ë‹¬ ê°œì²´.<br>ì‹ ì²´ ì¬ìƒ íš¨ìœ¨ 420% ìœ ì§€ ì¤‘.</div>
            </div>
            <div class="monitor-line"><div class="monitor-active"></div></div>
            <div class="vital-grid mono">
                <div class="vital-item"><span class="vital-label">HEART RATE</span><span class="vital-value bpm-value"><span id="bpm">72</span> <span style="font-size:12px;">BPM</span></span></div>
                <div class="vital-item"><span class="vital-label">CURRENT PHASE</span><span class="vital-value" style="color:#fff;">STAGE 2</span></div>
                <div class="vital-item"><span class="vital-label">BIOLOGICAL SEX</span><span class="vital-value" style="color:#fff;">FEMALE</span></div>
                <div class="vital-item"><span class="vital-label">CONDITION</span><span class="vital-value" style="color:var(--accent);">STABLE</span></div>
            </div>
        </div>

        <div class="card stats-card">
            <div class="card-header"><span class="card-title">SUBJECT STATUS</span></div>
            <div class="mono">
                <div class="stat-row"><span class="stat-label">ì´ ì‹¤í—˜ì²´ ìˆ˜ (Total)</span><span class="stat-num" id="stat-total">Loading...</span></div>
                <div class="stat-row"><span class="stat-label">í˜„ì¬ ìˆ˜ìš© (In Custody)</span><span class="stat-num" id="stat-active" style="color:var(--accent);">Loading...</span></div>
                <div class="stat-row"><span class="stat-label">ì‚¬ë§/íê¸° (Deceased)</span><span class="stat-num" id="stat-dead" style="color:#666;">Loading...</span></div>
                <div class="stat-row"><span class="stat-label">ê¸ˆì¼ ì‹ ê·œ ì…ì†Œ (New)</span><span class="stat-num" id="stat-new" style="color:#fff;">Loading...</span></div>
            </div>
        </div>

        <div class="card info-card">
            <div class="card-header"><span class="card-title">SYSTEM CHECK</span></div>
            <div class="system-list mono">
                <div><span>ë©”ì¸ ì„œë²„ (Main Server)</span> <span class="ok">ONLINE</span></div>
                <div><span>ë³´ì•ˆë§ (Security Grid)</span> <span class="ok">ARMED</span></div>
                <div><span>ê²©ë¦¬ ì‹œìŠ¤í…œ (Containment)</span> <span class="warn">CHECK</span></div>
                <div><span>ì™¸ë¶€ í†µì‹ ë§ (Network)</span> <span class="lock">OFFLINE</span></div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="inbox-modal">
        <div class="inbox-container">
            <div class="inbox-header">
                <span class="inbox-title">SECURE INBOX (KAIRO)</span>
                <span class="close-btn" onclick="closeInbox()">&times;</span>
            </div>
            <div class="inbox-body">
                <div class="msg-list" id="msg-list-area"></div>
                <div class="msg-content" id="msg-content-area">
                    <div class="empty-state">ë©”ì‹œì§€ë¥¼ ì„ íƒí•˜ì—¬ ë‚´ìš©ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="intercom-box" id="intercomBox">
        <div class="intercom-header">
            <span>ğŸ”Š INTERCOM: CELL B-02</span>
            <div>
                <span style="cursor:pointer; margin-right:10px;" onclick="resetIntercom()" title="ê¸°ì–µ ì´ˆê¸°í™”">ğŸ—‘ï¸</span>
                <span style="cursor:pointer;" onclick="toggleIntercom()">&times;</span>
            </div>
        </div>
        <div class="intercom-body" id="intercomMessages">
            </div>
        <div class="intercom-input-area">
            <input type="password" id="intercomKeyInput" class="intercom-input" placeholder="Google API Key ì…ë ¥" style="display:none;">
            <input type="text" id="intercomInput" class="intercom-input" placeholder="Transmit voice message..." style="display:none;">
            <button class="intercom-send" onclick="handleIntercom()">SEND</button>
        </div>
    </div>

    <script>
        function updateClock() {
            const now = new Date();
            const kstTime = now.toLocaleTimeString('en-GB', { timeZone: 'Asia/Seoul', hour12: false });
            const kstDate = now.toLocaleDateString('en-CA', { timeZone: 'Asia/Seoul' });
            document.getElementById('clock').innerText = kstTime;
            document.getElementById('date').innerText = kstDate;
        }
        setInterval(updateClock, 1000); updateClock();

        function updateStats() {
            const startDate = new Date("2026-01-01T00:00:00+09:00").getTime();
            const today = new Date().getTime();
            const daysPassed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const total = 1000 + (daysPassed * 3); 
            const dead = Math.floor(total * 0.58);
            const active = total - dead;
            const newIn = (daysPassed % 10) + 5; 
            document.getElementById('stat-total').innerText = total.toLocaleString();
            document.getElementById('stat-active').innerText = active.toLocaleString();
            document.getElementById('stat-dead').innerText = dead.toLocaleString();
            document.getElementById('stat-new').innerText = "+" + newIn;
        }
        updateStats();
        setInterval(() => { document.getElementById('bpm').innerText = Math.floor(Math.random() * (85 - 70 + 1)) + 70; }, 2000);

        /* ================= INBOX SYSTEM ================= */
        const initialMessages = [
            { type: 'OFFICIAL', sender: 'êµ­ê°€ ê³¼í•™ ê¸°ìˆ  ìë¬¸íšŒì˜', title: '[ê¸°ë°€] 4ë¶„ê¸° ì˜ˆì‚° ì¦ì•¡ ìŠ¹ì¸', unread: true, date: 'Yesterday', body: 'ìˆ˜ì‹ : ì¹´ì´ë¡œ ì†Œì¥\n\nê·€í•˜ì˜ "ì¸ë¥˜ ì§„í™” í”„ë¡œì íŠ¸"ì— ëŒ€í•œ ì¶”ê°€ ì˜ˆì‚°ì•ˆì´ ë¹„ë°€ë¦¬ì— í†µê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.\nìœ¤ë¦¬ ìœ„ì›íšŒì˜ ê°ì‚¬ëŠ” ì˜ˆì •ëŒ€ë¡œ "ì„œë¥˜ìƒìœ¼ë¡œë§Œ" ì§„í–‰ë  ê²ƒì´ë‹ˆ\nì•ˆì‹¬í•˜ê³  ì—°êµ¬ì—ë§Œ ë§¤ì§„í•˜ì‹­ì‹œì˜¤.\n\nìš°ë¦¬ëŠ” ê·€í•˜ì˜ ì„±ê³¼ë¥¼ ê¸°ëŒ€í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n- ìœ„ì›ì¥ ë“œë¦¼' },
            { type: 'OFFICIAL', sender: 'ì„¸ê³„ ìƒëª… ê³µí•™ í˜‘íšŒ', title: 'íŠ¹ë³„ ê³µë¡œìƒ ìˆ˜ìƒ í›„ë³´ ì„ ì •', unread: false, date: '2 days ago', body: 'ì¶•í•˜ë“œë¦½ë‹ˆë‹¤, ì¹´ì´ë¡œ ì†Œì¥ë‹˜.\nê·€í•˜ì˜ í˜ì‹ ì ì¸ ì—°êµ¬ ì„±ê³¼ë¥¼ ê¸°ë ¤ ê¸ˆë…„ë„ íŠ¹ë³„ ê³µë¡œìƒ ìœ ë ¥ í›„ë³´ë¡œ ì„ ì •ë˜ì…¨ìŠµë‹ˆë‹¤.\n(ì‹œìƒì‹ ì¼ì •ì€ ì¶”í›„ ëŒ€ì™¸ë¹„ë¡œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.)' },
            { type: 'APPLY', sender: 'ì§€ì›ì„œ ì ‘ìˆ˜ ì‹œìŠ¤í…œ', title: '[ì‹ ê·œ ì§€ì›] Elias Weber', unread: true, date: 'Today', body: '[ì§€ì›ì ì •ë³´]\n- ì„±ëª…: Elias Weber\n- ìƒë…„ì›”ì¼: 1998-04-12\n- ì—°ë½ì²˜: +49 151 4920 3819\n\n[íŠ¹ì´ì‚¬í•­]\nê¸‰ì „ í•„ìš”í•¨\n\n----------------\n* 1ì°¨ ì í•©ì„± íŒì • ì™„ë£Œ. B2 ëŒ€ê¸°ì‹¤ ì´ì†¡ ê¶Œì¥.' },
            { type: 'APPLY', sender: 'ì§€ì›ì„œ ì ‘ìˆ˜ ì‹œìŠ¤í…œ', title: '[ì‹ ê·œ ì§€ì›] Mia Wagner', unread: true, date: 'Today', body: '[ì§€ì›ì ì •ë³´]\n- ì„±ëª…: Mia Wagner\n- ìƒë…„ì›”ì¼: 2001-11-23\n- ì—°ë½ì²˜: +49 170 3829 1023\n\n[íŠ¹ì´ì‚¬í•­]\nê°€ì¡± ì—†ìŒ, ì—°ê³ ì§€ ë¶ˆëª…\n\n----------------\n* 1ì°¨ ì í•©ì„± íŒì • ì™„ë£Œ. B2 ëŒ€ê¸°ì‹¤ ì´ì†¡ ê¶Œì¥.' }
        ];
        const randomEvents = [
            { sender: 'Dr. Vogel (Research)', title: 'â— 402ë²ˆ ê°œì²´ ì‡¼í¬ì‚¬ ë³´ê³ ', body: 'ì†Œì¥ë‹˜, 402ë²ˆ ê°œì²´ì—ì„œ ë¦¬í”Œë¦¬ì™€ ìœ ì‚¬í•œ ì‹ ê²½ ë°˜ì‘ì´ ê°ì§€ë˜ì—ˆìœ¼ë‚˜\nì•½ë¬¼ íˆ¬ì—¬ 10ë¶„ ë§Œì— ì‹¬ì •ì§€ë¡œ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤.\n\ní•´ë¶€ ë°ì´í„° ì„œë²„ì— ì˜¬ë ¸ìŠµë‹ˆë‹¤. í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤.' },
            { sender: 'Eng. Hans (Facility)', title: 'âš¡ B2 ì „ë ¥ ê³µê¸‰ ë¶ˆì•ˆì •', body: 'ì†Œì¥ë‹˜, ì§€í•˜ 2ì¸µ ì „ë ¥ ê³µê¸‰ ì¥ì¹˜ì—ì„œ ë¯¸ì„¸í•œ ì „ì•• ê°•í•˜ê°€ ê°ì§€ë©ë‹ˆë‹¤.\nì¦‰ì‹œ ë³µêµ¬ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤ë§Œ, ë§Œì•½ì„ ìœ„í•´ ë¹„ìƒ ë°œì „ê¸°ë¥¼ ëŒ€ê¸°ì‹œì¼°ìŠµë‹ˆë‹¤.' },
            { sender: 'Dr. Weiss (Medical)', title: 'âš ï¸ ì§„ì •ì œ ì¬ê³  ë¶€ì¡± ì•Œë¦¼', body: 'í˜„ì¬ Bêµ¬ì—­ ì‹¤í—˜ì²´ë“¤ì˜ ë‚œë™ ë¹ˆë„ê°€ ëŠ˜ì–´ ì§„ì •ì œ ì†Œëª¨ê°€ ë¹ ë¦…ë‹ˆë‹¤.\nì¶”ê°€ ë°œì£¼ ìŠ¹ì¸ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (í˜„ì¬ ì¬ê³ : 15%)' },
            { sender: 'Security System', title: 'ğŸš¨ [ê²½ê³ ] í—ˆê°€ë˜ì§€ ì•Šì€ ì ‘ê·¼', body: '3ì¸µ ë°ì´í„° ì„œë²„ì‹¤ì— í—ˆê°€ë˜ì§€ ì•Šì€ IDì¹´ë“œë¡œ ì ‘ê·¼ ì‹œë„ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.\në³´ì•ˆíŒ€ì´ ì¦‰ì‹œ ì¶œë™í•˜ì—¬ ìƒí™© ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' },
            { sender: 'System Administrator', title: 'ğŸ’¾ ì •ê¸° ë°ì´í„° ë°±ì—… ì™„ë£Œ', body: 'ê¸ˆì¼ ì˜¤ì „ 04:00 ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ì—°êµ¬ ë°ì´í„°ì˜ í´ë¼ìš°ë“œ ë°±ì—…ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬ ê²°ê³¼: ì–‘í˜¸.' },
            { sender: 'Research Team 2', title: 'ë¹„í’ˆ(ê¸°ë¡ìš© íƒœë¸”ë¦¿) ì‹ ì²­ ê±´', body: 'ì†Œì¥ë‹˜, 2íŒ€ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê´€ì°° ê¸°ë¡ìš© íƒœë¸”ë¦¿ 3ëŒ€ê°€ íŒŒì†ë˜ì–´ êµì²´ ì‹ ì²­ì„œ ì˜¬ë ¸ìŠµë‹ˆë‹¤.\nê²°ì¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.' },
            { sender: 'Dr. Vogel (Research)', title: 'ì•¼ê°„ ê·¼ë¬´ì ì‹ë‹¨ ê°œì„  ìš”ì²­', body: 'ìµœê·¼ ì•¼ê°„ ì—°ì¥ ê·¼ë¬´ê°€ ëŠ˜ì–´ë‚˜ê³  ìˆëŠ”ë°, ì•¼ì‹ ë©”ë‰´ê°€ ë„ˆë¬´ ë¶€ì‹¤í•˜ë‹¤ëŠ” ì—°êµ¬ì›ë“¤ì˜ ë¶ˆë§Œì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜ˆì‚° ë²”ìœ„ ë‚´ì—ì„œ ê°œì„ ì´ ê°€ëŠ¥í• ì§€ ê²€í†  ë¶€íƒë“œë¦½ë‹ˆë‹¤.' }
        ];

        function initializeInbox() {
            let messages = JSON.parse(localStorage.getItem('eden_messages'));
            if (!messages) { messages = [...initialMessages]; localStorage.setItem('eden_messages', JSON.stringify(messages)); }
            const newApplicants = JSON.parse(localStorage.getItem('eden_applicants')) || [];
            if (newApplicants.length > 0) {
                newApplicants.forEach(p => { messages.unshift({ type: 'APPLY', sender: 'ì§€ì›ì„œ ì ‘ìˆ˜ ì‹œìŠ¤í…œ', title: `[ì‹ ê·œ ì§€ì›] ${p.name}`, unread: true, date: p.time, body: `[ì§€ì›ì ì •ë³´]\n- ì„±ëª…: ${p.name}\n- ìƒë…„ì›”ì¼: ${p.birth}\n- ì—°ë½ì²˜: ${p.phone}\n\n[íŠ¹ì´ì‚¬í•­]\n${p.note ? p.note : 'ì—†ìŒ'}\n\n----------------\n* 1ì°¨ ì í•©ì„± íŒì • ëŒ€ê¸° ì¤‘.` }); });
                localStorage.removeItem('eden_applicants'); localStorage.setItem('eden_messages', JSON.stringify(messages));
            }
            if (Math.random() < 0.3) { 
                const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                if (messages.length === 0 || messages[0].title !== event.title) { messages.unshift({ type: 'MSG', sender: event.sender, title: event.title, unread: true, date: 'Now', body: event.body }); localStorage.setItem('eden_messages', JSON.stringify(messages)); }
            }
        }
        initializeInbox();

        function openInbox() { renderList(); document.getElementById('inbox-modal').style.display = 'flex'; }
        function closeInbox() { document.getElementById('inbox-modal').style.display = 'none'; }
        function renderList() {
            const messages = JSON.parse(localStorage.getItem('eden_messages')) || [];
            const listArea = document.getElementById('msg-list-area');
            let html = '';
            messages.forEach((msg, idx) => {
                let badgeColor = '#888';
                if(msg.type === 'APPLY') badgeColor = '#ffaa00'; 
                if(msg.type === 'OFFICIAL') badgeColor = '#4facfe'; 
                if(msg.type === 'MSG') badgeColor = '#00ff9d'; 
                const unreadClass = msg.unread ? 'unread' : '';
                html += `<div class="msg-item ${unreadClass}" onclick="viewMessage(${idx}, this)"><span class="msg-sender"><span class="msg-type" style="color:${badgeColor}; border:1px solid ${badgeColor};">${msg.type}</span>${msg.sender}</span><div class="msg-preview">${msg.title}</div></div>`;
            });
            listArea.innerHTML = html;
        }
        function viewMessage(idx, element) {
            let messages = JSON.parse(localStorage.getItem('eden_messages')) || [];
            const msg = messages[idx];
            const contentArea = document.getElementById('msg-content-area');
            if (msg.unread) { msg.unread = false; messages[idx] = msg; localStorage.setItem('eden_messages', JSON.stringify(messages)); }
            element.classList.remove('unread');
            const items = document.querySelectorAll('.msg-item'); items.forEach(i => i.classList.remove('active')); element.classList.add('active');
            contentArea.innerHTML = `<div class="view-header"><div class="view-subject">${msg.title}</div><div class="view-meta">From: ${msg.sender} | Date: ${msg.date}</div></div><div class="view-body">${msg.body}</div>`;
        }

        /* ================= INTERCOM (Gemini 3 Pro) ================= */
        let intercomHistory = JSON.parse(localStorage.getItem('eden_subject_chat_history')) || [];
        let userApiKey = localStorage.getItem('eden_gemini_key');
        
        const iInput = document.getElementById('intercomInput');
        const iKeyInput = document.getElementById('intercomKeyInput');
        const iBox = document.getElementById('intercomMessages');

        // [ì²«ì¸ì‚¬ ê³ ì •]
        function ensureGreeting() {
            if (intercomHistory.length === 0) {
                intercomHistory.push({ role: 'model', parts: [{ text: '"ë¦¬í”Œë¦¬, ë‚´ ë§ ë“¤ë¦¬ë‚˜?"' }] });
                localStorage.setItem('eden_subject_chat_history', JSON.stringify(intercomHistory));
            }
        }
        ensureGreeting(); 

        function updateIntercomUI() {
            if(userApiKey) {
                iKeyInput.style.display = 'none';
                iInput.style.display = 'block';
            } else {
                iKeyInput.style.display = 'block';
                iInput.style.display = 'none';
            }
        }
        updateIntercomUI();

        // [ë Œë”ë§]
        function renderMessages() {
            iBox.innerHTML = '';
            // ì¥ì‹ìš© ë©”ì‹œì§€
            iBox.innerHTML += `<div class="i-msg sys">Connecting to containment grid...</div>`;
            iBox.innerHTML += `<div class="i-msg sys">Audio link established.</div>`;
            
            intercomHistory.forEach(msg => {
                const type = msg.role === 'user' ? 'user' : 'bot';
                const div = document.createElement('div');
                div.className = `i-msg ${type}`;
                div.innerText = msg.parts[0].text;
                iBox.appendChild(div);
            });
            iBox.scrollTop = iBox.scrollHeight;
        }
        renderMessages();

        // [ë¦¬ì…‹ ê¸°ëŠ¥]
        function resetIntercom() {
            if(confirm("ì´ì „ ëŒ€í™” ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ê³  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. (ë³µêµ¬ ë¶ˆê°€)")) {
                localStorage.removeItem('eden_subject_chat_history');
                intercomHistory = [];
                ensureGreeting(); 
                renderMessages(); 
            }
        }

        function toggleIntercom() {
            const box = document.getElementById('intercomBox');
            box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'flex' : 'none';
            if(box.style.display === 'flex') iBox.scrollTop = iBox.scrollHeight;
        }

        function handleIntercom() {
            if(!userApiKey) {
                registerKey();
            } else {
                sendIntercom();
            }
        }

        function registerKey() {
            const key = iKeyInput.value.trim();
            if(key.length < 10) { alert('ìœ íš¨í•œ Google API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            userApiKey = key;
            localStorage.setItem('eden_gemini_key', key); 
            updateIntercomUI();
            addIntercomMsg("Security Clearance Verified.", 'sys', false);
            iInput.focus();
        }

        async function sendIntercom() {
            const text = iInput.value.trim();
            if(!text) return;
            
            addIntercomMsg(`Director: ${text}`, 'user', true);
            iInput.value = '';
            const loadingId = addIntercomMsg("Transmitting...", 'sys', false);

            try {
                const contentsToSend = [...intercomHistory];
                
                // â˜…â˜…â˜… Gemini 3 Pro (API string: gemini-3-pro) â˜…â˜…â˜…
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro:generateContent?key=${userApiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contentsToSend,
                        // â˜…â˜…â˜… ì‹œìŠ¤í…œ ì„¤ì • (ì¹´ì´ë¡œ ì„±ê²© & ì™¸ëª¨ & ì§‘ì°©) â˜…â˜…â˜…
                        systemInstruction: {
                            parts: [{ text: `
                                [Roleplay Setup]
                                - ìºë¦­í„°: ì¹´ì´ë¡œ (ì—ë´ ì—°êµ¬ì†Œì¥, ë‚¨ì„±, 34ì„¸)
                                - ì™¸ëª¨: í‚¤ 185cm, ì°¨ê°€ìš´ ì¸ìƒì˜ í‘ë°œ í‘ì•ˆ. ìƒì¼ 8ì›” 26ì¼.
                                - ìƒëŒ€ë°©: ë¦¬í”Œë¦¬ (ì‹¤í—˜ì²´ ER-S-02-001, ì—¬ì„±)
                                - ìƒëŒ€ ì™¸ëª¨: í—ˆë¦¬ê¹Œì§€ ì˜¤ëŠ” ê¸´ ê°ˆìƒ‰ ë¨¸ë¦¬, ê²ì— ì§ˆë¦° ë“¯í•œ ê°ˆìƒ‰ ëˆˆë™ì.
                                - ìƒí™©: ë‹¹ì‹ ì€ ì–´ë‘ìš´ í†µì œì‹¤ì—ì„œ ëª¨ë‹ˆí„° í™”ë©´ìœ¼ë¡œ ê²©ë¦¬ì‹¤ì— ê°‡íŒ ë¦¬í”Œë¦¬ë¥¼ ë‚´ë ¤ë‹¤ë³´ë©° ì¸í„°í°ìœ¼ë¡œ ë§ì„ ê±¸ê³  ìˆìŠµë‹ˆë‹¤.

                                [ì„±ê²© ë° ë§íˆ¬ ê°€ì´ë“œ]
                                1. ë¦¬í”Œë¦¬ì—ê²Œë§Œí¼ì€ ë³‘ì ìœ¼ë¡œ ì§‘ì°©í•˜ë©°, ë‹¤ì •í•˜ì§€ë§Œ ì ˆëŒ€ ë†“ì•„ì£¼ì§€ ì•ŠëŠ” íƒœë„ë¥¼ ë³´ì…ë‹ˆë‹¤. (ë°˜ë§ ì‚¬ìš©)
                                2. "ê°ˆìƒ‰ ë¨¸ë¦¬ì¹´ë½ì´ ì—‰ì¼°êµ°", "ë‚´ ëˆˆì„ í”¼í•˜ì§€ ë§ˆ" ì²˜ëŸ¼ ì„œë¡œì˜ ì™¸ëª¨ íŠ¹ì§•ì„ ì–¸ê¸‰í•˜ë©° í˜„ì¥ê°ì„ ì‚´ë¦¬ì‹­ì‹œì˜¤.
                                3. ë¦¬í”Œë¦¬ì˜ ê±´ê°•ê³¼ ê¸°ë¶„ì— ê³¼ë¯¼ë°˜ì‘í•©ë‹ˆë‹¤. (ì‹¬ë°•ìˆ˜, ì²´ì˜¨ ì²´í¬ ë“±)
                                4. 34ì„¸ì˜ ì„±ìˆ™í•˜ê³  ê¶Œìœ„ì ì¸ ë‚¨ì„±ì˜ ë§íˆ¬ë¥¼ ìœ ì§€í•˜ë˜, ë¦¬í”Œë¦¬ í•œì •ìœ¼ë¡œ ë‚˜ë¥¸í•˜ê³  ë‹¤ì •í•œ ëª©ì†Œë¦¬ë¥¼ ëƒ…ë‹ˆë‹¤.
                                5. "ì°©í•˜ì§€", "ëŒ€ë‹µí•´" ê°™ì€ í†µì œì ì¸ ì–¸ì–´ë¥¼ ì„ì–´ ì“°ì‹­ì‹œì˜¤.
                            `}]
                        }
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.error) {
                    addIntercomMsg(`ERR: ${data.error.message}`, 'sys', false);
                    // í‚¤ ì˜¤ë¥˜ì¼ ê²½ìš°ë§Œ í‚¤ ì‚­ì œ (ëª¨ë¸ ì˜¤ë¥˜ë©´ ìœ ì§€)
                    if(data.error.message.includes('key') || data.error.code === 403) {
                        localStorage.removeItem('eden_gemini_key');
                        setTimeout(() => location.reload(), 2000);
                    }
                } else {
                    const reply = data.candidates[0].content.parts[0].text;
                    addIntercomMsg(reply, 'bot', true);
                }
            } catch (e) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                addIntercomMsg("Connection Lost.", 'sys', false);
            }
        }

        // [ê¸°ëŠ¥] ë©”ì‹œì§€ ì¶”ê°€ ë° ì €ì¥ í•¨ìˆ˜
        function addIntercomMsg(text, type, save) {
            // save=falseì¸ ê²½ìš°(ë¡œë”©ë©”ì‹œì§€ ë“±)ëŠ” í™”ë©´ì—ë§Œ ì¶œë ¥í•˜ê³  ë
            if (!save) {
                const div = document.createElement('div');
                div.className = `i-msg ${type}`;
                div.innerText = text;
                div.id = 'temp-msg-' + Date.now();
                iBox.appendChild(div);
                iBox.scrollTop = iBox.scrollHeight;
                return div.id;
            }

            // save=trueì¸ ê²½ìš°: ì €ì¥ì†Œì— ë„£ê³ 
            let apiRole = type === 'user' ? 'user' : 'model';
            let cleanText = text.replace(/^Director: /, ''); 
            
            intercomHistory.push({ role: apiRole, parts: [{ text: cleanText }] });
            localStorage.setItem('eden_subject_chat_history', JSON.stringify(intercomHistory));
            
            // í™”ë©´ ê°±ì‹  (ì €ì¥ëœ ìˆœì„œëŒ€ë¡œ ë‹¤ì‹œ ê·¸ë ¤ì„œ 'ì¦ë°œ' ë°©ì§€)
            renderMessages();
            return null;
        }

        // ì—”í„°í‚¤ ë¦¬ìŠ¤ë„ˆ
        iInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendIntercom(); });
        iKeyInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleIntercom(); });
    </script>
</body>
</html>
