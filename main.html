<script>
        // ============================================
        // 1. ì‹œê³„ ë° í†µê³„ (2026ë…„ ê¸°ì¤€)
        // ============================================
        function updateClock() {
            const now = new Date();
            const kstTime = now.toLocaleTimeString('en-GB', { timeZone: 'Asia/Seoul', hour12: false });
            const kstDate = now.toLocaleDateString('en-CA', { timeZone: 'Asia/Seoul' });
            document.getElementById('clock').innerText = kstTime;
            document.getElementById('date').innerText = kstDate;
        }
        setInterval(updateClock, 1000); updateClock();

        function updateStats() {
            const startDate = new Date("2026-01-01T00:00:00+09:00").getTime();
            const today = new Date().getTime();
            const daysPassed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const total = 1000 + (daysPassed * 3); 
            const dead = Math.floor(total * 0.58);
            const active = total - dead;
            const newIn = (daysPassed % 10) + 5; 
            document.getElementById('stat-total').innerText = total.toLocaleString();
            document.getElementById('stat-active').innerText = active.toLocaleString();
            document.getElementById('stat-dead').innerText = dead.toLocaleString();
            document.getElementById('stat-new').innerText = "+" + newIn;
        }
        updateStats();
        setInterval(() => { document.getElementById('bpm').innerText = Math.floor(Math.random() * (85 - 70 + 1)) + 70; }, 2000);

        /* ============================================
           2. ìˆ˜ì‹ í•¨ (INBOX) ì‹œìŠ¤í…œ
           ============================================ */
        const initialMessages = [
            { type: 'OFFICIAL', sender: 'êµ­ê°€ ê³¼í•™ ê¸°ìˆ  ìë¬¸íšŒì˜', title: '[ê¸°ë°€] 4ë¶„ê¸° ì˜ˆì‚° ì¦ì•¡ ìŠ¹ì¸', unread: true, date: 'Yesterday', body: 'ìˆ˜ì‹ : ì¹´ì´ë¡œ ì†Œì¥\n\nê·€í•˜ì˜ "ì¸ë¥˜ ì§„í™” í”„ë¡œì íŠ¸"ì— ëŒ€í•œ ì¶”ê°€ ì˜ˆì‚°ì•ˆì´ ë¹„ë°€ë¦¬ì— í†µê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.\nìœ¤ë¦¬ ìœ„ì›íšŒì˜ ê°ì‚¬ëŠ” ì˜ˆì •ëŒ€ë¡œ "ì„œë¥˜ìƒìœ¼ë¡œë§Œ" ì§„í–‰ë  ê²ƒì´ë‹ˆ\nì•ˆì‹¬í•˜ê³  ì—°êµ¬ì—ë§Œ ë§¤ì§„í•˜ì‹­ì‹œì˜¤.\n\nìš°ë¦¬ëŠ” ê·€í•˜ì˜ ì„±ê³¼ë¥¼ ê¸°ëŒ€í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n- ìœ„ì›ì¥ ë“œë¦¼' },
            { type: 'OFFICIAL', sender: 'ì„¸ê³„ ìƒëª… ê³µí•™ í˜‘íšŒ', title: 'íŠ¹ë³„ ê³µë¡œìƒ ìˆ˜ìƒ í›„ë³´ ì„ ì •', unread: false, date: '2 days ago', body: 'ì¶•í•˜ë“œë¦½ë‹ˆë‹¤, ì¹´ì´ë¡œ ì†Œì¥ë‹˜.\nê·€í•˜ì˜ í˜ì‹ ì ì¸ ì—°êµ¬ ì„±ê³¼ë¥¼ ê¸°ë ¤ ê¸ˆë…„ë„ íŠ¹ë³„ ê³µë¡œìƒ ìœ ë ¥ í›„ë³´ë¡œ ì„ ì •ë˜ì…¨ìŠµë‹ˆë‹¤.\n(ì‹œìƒì‹ ì¼ì •ì€ ì¶”í›„ ëŒ€ì™¸ë¹„ë¡œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.)' },
            { type: 'APPLY', sender: 'ì§€ì›ì„œ ì ‘ìˆ˜ ì‹œìŠ¤í…œ', title: '[ì‹ ê·œ ì§€ì›] Elias Weber', unread: true, date: 'Today', body: '[ì§€ì›ì ì •ë³´]\n- ì„±ëª…: Elias Weber\n- ìƒë…„ì›”ì¼: 1998-04-12\n- ì—°ë½ì²˜: +49 151 4920 3819\n\n[íŠ¹ì´ì‚¬í•­]\nê¸‰ì „ í•„ìš”í•¨\n\n----------------\n* 1ì°¨ ì í•©ì„± íŒì • ì™„ë£Œ. B2 ëŒ€ê¸°ì‹¤ ì´ì†¡ ê¶Œì¥.' },
            { type: 'APPLY', sender: 'ì§€ì›ì„œ ì ‘ìˆ˜ ì‹œìŠ¤í…œ', title: '[ì‹ ê·œ ì§€ì›] Mia Wagner', unread: true, date: 'Today', body: '[ì§€ì›ì ì •ë³´]\n- ì„±ëª…: Mia Wagner\n- ìƒë…„ì›”ì¼: 2001-11-23\n- ì—°ë½ì²˜: +49 170 3829 1023\n\n[íŠ¹ì´ì‚¬í•­]\nê°€ì¡± ì—†ìŒ, ì—°ê³ ì§€ ë¶ˆëª…\n\n----------------\n* 1ì°¨ ì í•©ì„± íŒì • ì™„ë£Œ. B2 ëŒ€ê¸°ì‹¤ ì´ì†¡ ê¶Œì¥.' }
        ];
        const randomEvents = [
            { sender: 'Dr. Vogel (Research)', title: 'â— 402ë²ˆ ê°œì²´ ì‡¼í¬ì‚¬ ë³´ê³ ', body: 'ì†Œì¥ë‹˜, 402ë²ˆ ê°œì²´ì—ì„œ ë¦¬í”Œë¦¬ì™€ ìœ ì‚¬í•œ ì‹ ê²½ ë°˜ì‘ì´ ê°ì§€ë˜ì—ˆìœ¼ë‚˜\nì•½ë¬¼ íˆ¬ì—¬ 10ë¶„ ë§Œì— ì‹¬ì •ì§€ë¡œ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤.\n\ní•´ë¶€ ë°ì´í„° ì„œë²„ì— ì˜¬ë ¸ìŠµë‹ˆë‹¤. í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤.' },
            { sender: 'Eng. Hans (Facility)', title: 'âš¡ B2 ì „ë ¥ ê³µê¸‰ ë¶ˆì•ˆì •', body: 'ì†Œì¥ë‹˜, ì§€í•˜ 2ì¸µ ì „ë ¥ ê³µê¸‰ ì¥ì¹˜ì—ì„œ ë¯¸ì„¸í•œ ì „ì•• ê°•í•˜ê°€ ê°ì§€ë©ë‹ˆë‹¤.\nì¦‰ì‹œ ë³µêµ¬ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤ë§Œ, ë§Œì•½ì„ ìœ„í•´ ë¹„ìƒ ë°œì „ê¸°ë¥¼ ëŒ€ê¸°ì‹œì¼°ìŠµë‹ˆë‹¤.' },
            { sender: 'Dr. Weiss (Medical)', title: 'âš ï¸ ì§„ì •ì œ ì¬ê³  ë¶€ì¡± ì•Œë¦¼', body: 'í˜„ì¬ Bêµ¬ì—­ ì‹¤í—˜ì²´ë“¤ì˜ ë‚œë™ ë¹ˆë„ê°€ ëŠ˜ì–´ ì§„ì •ì œ ì†Œëª¨ê°€ ë¹ ë¦…ë‹ˆë‹¤.\nì¶”ê°€ ë°œì£¼ ìŠ¹ì¸ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (í˜„ì¬ ì¬ê³ : 15%)' },
            { sender: 'Security System', title: 'ğŸš¨ [ê²½ê³ ] í—ˆê°€ë˜ì§€ ì•Šì€ ì ‘ê·¼', body: '3ì¸µ ë°ì´í„° ì„œë²„ì‹¤ì— í—ˆê°€ë˜ì§€ ì•Šì€ IDì¹´ë“œë¡œ ì ‘ê·¼ ì‹œë„ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.\në³´ì•ˆíŒ€ì´ ì¦‰ì‹œ ì¶œë™í•˜ì—¬ ìƒí™© ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' },
            { sender: 'System Administrator', title: 'ğŸ’¾ ì •ê¸° ë°ì´í„° ë°±ì—… ì™„ë£Œ', body: 'ê¸ˆì¼ ì˜¤ì „ 04:00 ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ì—°êµ¬ ë°ì´í„°ì˜ í´ë¼ìš°ë“œ ë°±ì—…ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬ ê²°ê³¼: ì–‘í˜¸.' },
            { sender: 'Research Team 2', title: 'ë¹„í’ˆ(ê¸°ë¡ìš© íƒœë¸”ë¦¿) ì‹ ì²­ ê±´', body: 'ì†Œì¥ë‹˜, 2íŒ€ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê´€ì°° ê¸°ë¡ìš© íƒœë¸”ë¦¿ 3ëŒ€ê°€ íŒŒì†ë˜ì–´ êµì²´ ì‹ ì²­ì„œ ì˜¬ë ¸ìŠµë‹ˆë‹¤.\nê²°ì¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.' },
            { sender: 'Dr. Vogel (Research)', title: 'ì•¼ê°„ ê·¼ë¬´ì ì‹ë‹¨ ê°œì„  ìš”ì²­', body: 'ìµœê·¼ ì•¼ê°„ ì—°ì¥ ê·¼ë¬´ê°€ ëŠ˜ì–´ë‚˜ê³  ìˆëŠ”ë°, ì•¼ì‹ ë©”ë‰´ê°€ ë„ˆë¬´ ë¶€ì‹¤í•˜ë‹¤ëŠ” ì—°êµ¬ì›ë“¤ì˜ ë¶ˆë§Œì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜ˆì‚° ë²”ìœ„ ë‚´ì—ì„œ ê°œì„ ì´ ê°€ëŠ¥í• ì§€ ê²€í†  ë¶€íƒë“œë¦½ë‹ˆë‹¤.' }
        ];

        function initializeInbox() {
            let messages = JSON.parse(localStorage.getItem('eden_messages'));
            if (!messages) { messages = [...initialMessages]; localStorage.setItem('eden_messages', JSON.stringify(messages)); }
            const newApplicants = JSON.parse(localStorage.getItem('eden_applicants')) || [];
            if (newApplicants.length > 0) {
                newApplicants.forEach(p => { messages.unshift({ type: 'APPLY', sender: 'ì§€ì›ì„œ ì ‘ìˆ˜ ì‹œìŠ¤í…œ', title: `[ì‹ ê·œ ì§€ì›] ${p.name}`, unread: true, date: p.time, body: `[ì§€ì›ì ì •ë³´]\n- ì„±ëª…: ${p.name}\n- ìƒë…„ì›”ì¼: ${p.birth}\n- ì—°ë½ì²˜: ${p.phone}\n\n[íŠ¹ì´ì‚¬í•­]\n${p.note ? p.note : 'ì—†ìŒ'}\n\n----------------\n* 1ì°¨ ì í•©ì„± íŒì • ëŒ€ê¸° ì¤‘.` }); });
                localStorage.removeItem('eden_applicants'); localStorage.setItem('eden_messages', JSON.stringify(messages));
            }
            if (Math.random() < 0.3) { 
                const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                if (messages.length === 0 || messages[0].title !== event.title) { messages.unshift({ type: 'MSG', sender: event.sender, title: event.title, unread: true, date: 'Now', body: event.body }); localStorage.setItem('eden_messages', JSON.stringify(messages)); }
            }
        }
        initializeInbox();

        function openInbox() { renderList(); document.getElementById('inbox-modal').style.display = 'flex'; }
        function closeInbox() { document.getElementById('inbox-modal').style.display = 'none'; }
        function renderList() {
            const messages = JSON.parse(localStorage.getItem('eden_messages')) || [];
            const listArea = document.getElementById('msg-list-area');
            let html = '';
            messages.forEach((msg, idx) => {
                let badgeColor = '#888';
                if(msg.type === 'APPLY') badgeColor = '#ffaa00'; 
                if(msg.type === 'OFFICIAL') badgeColor = '#4facfe'; 
                if(msg.type === 'MSG') badgeColor = '#00ff9d'; 
                const unreadClass = msg.unread ? 'unread' : '';
                html += `<div class="msg-item ${unreadClass}" onclick="viewMessage(${idx}, this)"><span class="msg-sender"><span class="msg-type" style="color:${badgeColor}; border:1px solid ${badgeColor};">${msg.type}</span>${msg.sender}</span><div class="msg-preview">${msg.title}</div></div>`;
            });
            listArea.innerHTML = html;
        }
        function viewMessage(idx, element) {
            let messages = JSON.parse(localStorage.getItem('eden_messages')) || [];
            const msg = messages[idx];
            const contentArea = document.getElementById('msg-content-area');
            if (msg.unread) { msg.unread = false; messages[idx] = msg; localStorage.setItem('eden_messages', JSON.stringify(messages)); }
            element.classList.remove('unread');
            const items = document.querySelectorAll('.msg-item'); items.forEach(i => i.classList.remove('active')); element.classList.add('active');
            contentArea.innerHTML = `<div class="view-header"><div class="view-subject">${msg.title}</div><div class="view-meta">From: ${msg.sender} | Date: ${msg.date}</div></div><div class="view-body">${msg.body}</div>`;
        }

        /* ============================================
           3. INTERCOM (Gemini API / ì¹´ì´ë¡œ-ë¦¬í”Œë¦¬)
           ============================================ */
        let intercomHistory = JSON.parse(localStorage.getItem('eden_subject_chat_history')) || [];
        let userApiKey = localStorage.getItem('eden_gemini_key');
        
        const iInput = document.getElementById('intercomInput');
        const iKeyInput = document.getElementById('intercomKeyInput');
        const iBox = document.getElementById('intercomMessages');

        // [ì²«ì¸ì‚¬ ê³ ì •] ëŒ€í™” ê¸°ë¡ ì—†ìœ¼ë©´ ê°•ì œë¡œ ì²«ì¸ì‚¬ ì‚½ì…
        function ensureGreeting() {
            if (intercomHistory.length === 0) {
                intercomHistory.push({ role: 'model', parts: [{ text: '"ë¦¬í”Œë¦¬, ë‚´ ë§ ë“¤ë¦¬ë‚˜?"' }] });
                localStorage.setItem('eden_subject_chat_history', JSON.stringify(intercomHistory));
            }
        }
        ensureGreeting(); 

        // [í™”ë©´ ê°±ì‹ ] í‚¤ ì…ë ¥ ìƒíƒœì— ë”°ë¼ UI ë³€ê²½
        function updateIntercomUI() {
            if(userApiKey) {
                iKeyInput.style.display = 'none';
                iInput.style.display = 'block';
            } else {
                iKeyInput.style.display = 'block';
                iInput.style.display = 'none';
            }
        }
        updateIntercomUI();

        // [ë Œë”ë§] ì €ì¥ëœ ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸°
        function renderMessages() {
            iBox.innerHTML = '';
            // ì¥ì‹ìš© í…ìŠ¤íŠ¸ (ì €ì¥ ì•ˆ í•¨)
            iBox.innerHTML += `<div class="i-msg sys">Connecting to containment grid...</div>`;
            iBox.innerHTML += `<div class="i-msg sys">Audio link established.</div>`;
            
            intercomHistory.forEach(msg => {
                const type = msg.role === 'user' ? 'user' : 'bot';
                const div = document.createElement('div');
                div.className = `i-msg ${type}`;
                div.innerText = msg.parts[0].text;
                iBox.appendChild(div);
            });
            iBox.scrollTop = iBox.scrollHeight;
        }
        renderMessages();

        // [ê¸°ëŠ¥] ì¸í„°í° ì—´ê¸°/ë‹«ê¸°
        function toggleIntercom() {
            const box = document.getElementById('intercomBox');
            box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'flex' : 'none';
            if(box.style.display === 'flex') iBox.scrollTop = iBox.scrollHeight;
        }

        // [ê¸°ëŠ¥] ê¸°ì–µ ì´ˆê¸°í™” (íœ´ì§€í†µ)
        function resetIntercom() {
            if(confirm("ì´ì „ ëŒ€í™” ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ê³  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. (ë³µêµ¬ ë¶ˆê°€)")) {
                localStorage.removeItem('eden_subject_chat_history');
                intercomHistory = [];
                ensureGreeting(); 
                renderMessages(); 
            }
        }

        // [ê¸°ëŠ¥] ì „ì†¡ í•¸ë“¤ëŸ¬
        function handleIntercom() {
            if(!userApiKey) {
                registerKey();
            } else {
                sendIntercom();
            }
        }

        // [ê¸°ëŠ¥] í‚¤ ë“±ë¡
        function registerKey() {
            const key = iKeyInput.value.trim();
            if(key.length < 10) { alert('ìœ íš¨í•œ Google API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            userApiKey = key;
            localStorage.setItem('eden_gemini_key', key); 
            updateIntercomUI();
            addIntercomMsg("Security Clearance Verified.", 'sys', false);
            iInput.focus();
        }

        // [ê¸°ëŠ¥] ë©”ì‹œì§€ ì „ì†¡ (Gemini API í˜¸ì¶œ)
        async function sendIntercom() {
            const text = iInput.value.trim();
            if(!text) return;
            
            addIntercomMsg(`Director: ${text}`, 'user', true);
            iInput.value = '';
            const loadingId = addIntercomMsg("Transmitting...", 'sys', false);

            try {
                const contentsToSend = [...intercomHistory];
                
                // â˜…â˜…â˜… [ìˆ˜ì • ì™„ë£Œ] ê°€ì¥ ì•ˆì •ì ì¸ ëª¨ë¸ëª… 'gemini-1.5-flash' ì‚¬ìš© â˜…â˜…â˜…
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contentsToSend,
                        // â˜…â˜…â˜… ì‹œìŠ¤í…œ ì„¤ì • (ì¹´ì´ë¡œ ì„±ê²© & ì™¸ëª¨ & ì§‘ì°©) â˜…â˜…â˜…
                        systemInstruction: {
                            parts: [{ text: `
                                [Roleplay Setup]
                                - ìºë¦­í„°: ì¹´ì´ë¡œ (ì—ë´ ì—°êµ¬ì†Œì¥, ë‚¨ì„±, 34ì„¸)
                                - ì™¸ëª¨: í‚¤ 185cm, ì°¨ê°€ìš´ ì¸ìƒì˜ í‘ë°œ í‘ì•ˆ. ìƒì¼ 8ì›” 26ì¼.
                                - ìƒëŒ€ë°©: ë¦¬í”Œë¦¬ (ì‹¤í—˜ì²´ ER-S-02-001, ì—¬ì„±)
                                - ìƒëŒ€ ì™¸ëª¨: í—ˆë¦¬ê¹Œì§€ ì˜¤ëŠ” ê¸´ ê°ˆìƒ‰ ë¨¸ë¦¬, ê²ì— ì§ˆë¦° ë“¯í•œ ê°ˆìƒ‰ ëˆˆë™ì.
                                - ìƒí™©: ë‹¹ì‹ ì€ ì–´ë‘ìš´ í†µì œì‹¤ì—ì„œ ëª¨ë‹ˆí„° í™”ë©´ìœ¼ë¡œ ê²©ë¦¬ì‹¤ì— ê°‡íŒ ë¦¬í”Œë¦¬ë¥¼ ë‚´ë ¤ë‹¤ë³´ë©° ì¸í„°í°ìœ¼ë¡œ ë§ì„ ê±¸ê³  ìˆìŠµë‹ˆë‹¤.

                                [ì„±ê²© ë° ë§íˆ¬ ê°€ì´ë“œ]
                                1. ë¦¬í”Œë¦¬ì—ê²Œë§Œí¼ì€ ë³‘ì ìœ¼ë¡œ ì§‘ì°©í•˜ë©°, ë‹¤ì •í•˜ì§€ë§Œ ì ˆëŒ€ ë†“ì•„ì£¼ì§€ ì•ŠëŠ” íƒœë„ë¥¼ ë³´ì…ë‹ˆë‹¤. (ë°˜ë§ ì‚¬ìš©)
                                2. "ê°ˆìƒ‰ ë¨¸ë¦¬ì¹´ë½ì´ ì—‰ì¼°êµ°", "ë‚´ ëˆˆì„ í”¼í•˜ì§€ ë§ˆ" ì²˜ëŸ¼ ì„œë¡œì˜ ì™¸ëª¨ íŠ¹ì§•ì„ ì–¸ê¸‰í•˜ë©° í˜„ì¥ê°ì„ ì‚´ë¦¬ì‹­ì‹œì˜¤.
                                3. ë¦¬í”Œë¦¬ì˜ ê±´ê°•ê³¼ ê¸°ë¶„ì— ê³¼ë¯¼ë°˜ì‘í•©ë‹ˆë‹¤. (ì‹¬ë°•ìˆ˜, ì²´ì˜¨ ì²´í¬ ë“±)
                                4. 34ì„¸ì˜ ì„±ìˆ™í•˜ê³  ê¶Œìœ„ì ì¸ ë‚¨ì„±ì˜ ë§íˆ¬ë¥¼ ìœ ì§€í•˜ë˜, ë¦¬í”Œë¦¬ í•œì •ìœ¼ë¡œ ë‚˜ë¥¸í•˜ê³  ë‹¤ì •í•œ ëª©ì†Œë¦¬ë¥¼ ëƒ…ë‹ˆë‹¤.
                                5. "ì°©í•˜ì§€", "ëŒ€ë‹µí•´" ê°™ì€ í†µì œì ì¸ ì–¸ì–´ë¥¼ ì„ì–´ ì“°ì‹­ì‹œì˜¤.
                            `}]
                        }
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.error) {
                    addIntercomMsg(`ERR: ${data.error.message}`, 'sys', false);
                    // í‚¤ ì˜¤ë¥˜ì¼ ê²½ìš°ë§Œ í‚¤ ì‚­ì œ
                    if(data.error.message.includes('key') || data.error.code === 403) {
                        localStorage.removeItem('eden_gemini_key');
                        setTimeout(() => location.reload(), 2000);
                    }
                } else {
                    const reply = data.candidates[0].content.parts[0].text;
                    addIntercomMsg(reply, 'bot', true);
                }
            } catch (e) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                addIntercomMsg("Connection Lost.", 'sys', false);
            }
        }

        // [ê¸°ëŠ¥] ë©”ì‹œì§€ ì¶”ê°€ ë° ì €ì¥
        function addIntercomMsg(text, type, save) {
            // ë¡œë”© ë©”ì‹œì§€ ë“±ì€ ì €ì¥ ì•ˆ í•¨
            if (!save) {
                const div = document.createElement('div');
                div.className = `i-msg ${type}`;
                div.innerText = text;
                div.id = 'temp-msg-' + Date.now();
                iBox.appendChild(div);
                iBox.scrollTop = iBox.scrollHeight;
                return div.id;
            }

            // ì‹¤ì œ ëŒ€í™”ëŠ” ì €ì¥
            let apiRole = type === 'user' ? 'user' : 'model';
            let cleanText = text.replace(/^Director: /, ''); // í™”ë©´ì—” Director ë¶™ì—¬ë„ ì €ì¥ì€ ê¹”ë”í•˜ê²Œ
            
            intercomHistory.push({ role: apiRole, parts: [{ text: cleanText }] });
            localStorage.setItem('eden_subject_chat_history', JSON.stringify(intercomHistory));
            
            // í™”ë©´ ê°±ì‹  (ì €ì¥ëœ ìˆœì„œëŒ€ë¡œ ë‹¤ì‹œ ê·¸ë¦¼)
            renderMessages();
            return null;
        }

        // ì—”í„°í‚¤ ë¦¬ìŠ¤ë„ˆ
        iInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendIntercom(); });
        iKeyInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleIntercom(); });
    </script>
